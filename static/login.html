<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SIA-Piau칤</title>
    <link rel="icon" type="image/svg+xml" href="/static/assets/favicon.svg">
    <link rel="stylesheet" href="/static/ui/base.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/login.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <h2>游댏 Acesso Seguro</h2>
            <p>Digite o token de acesso para continuar</p>
            
            <div class="error-message" id="error-message"></div>
            
            <form id="login-form">
                <div class="login-form-group">
                    <label for="token-input">Token de Acesso</label>
                    <input 
                        type="password" 
                        id="token-input" 
                        placeholder="Digite o token"
                        required
                        autocomplete="off"
                    >
                </div>
                
                <button type="submit" class="login-button" id="login-button">
                    Entrar
                </button>
            </form>
        </div>
    </div>
    
    <script src="/static/ui/utils.js"></script>
    <script>
        const API_BASE_URL = (window.SIAUtils && window.SIAUtils.getApiBaseUrl)
            ? window.SIAUtils.getApiBaseUrl()
            : (window.location && window.location.origin ? window.location.origin : 'http://localhost:8000');
        const loginForm = document.getElementById('login-form');
        const tokenInput = document.getElementById('token-input');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        
        // Fun칞칚o para sanitizar input
        function sanitizeInput(value) {
            if (!value) return '';
            // Remove caracteres perigosos e limita tamanho
            return value.toString()
                .replace(/[<>]/g, '')
                .substring(0, 500)
                .trim();
        }
        
        // Fun칞칚o para mostrar erro
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }
        
        // Verificar se j치 est치 autenticado
        let isCheckingAuth = false;
        let hasCheckedAuth = false;
        
        async function checkAuth() {
            // Evita m칰ltiplas verifica칞칫es simult칙neas ou repetidas
            if (isCheckingAuth || hasCheckedAuth) return;
            isCheckingAuth = true;
            hasCheckedAuth = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // S칩 redireciona se a resposta for OK (200) e v치lida
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.valid === true) {
                        // J치 autenticado, redireciona apenas uma vez
                        window.location.replace('/');
                        return;
                    }
                }
            } catch (error) {
                // Ignora erro, continua na tela de login
                console.log('N칚o autenticado, permanecendo na tela de login');
            } finally {
                isCheckingAuth = false;
            }
        }
        
        // Handler de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = sanitizeInput(tokenInput.value);
            
            if (!token) {
                showError('Por favor, digite o token de acesso');
                return;
            }
            
            loginButton.disabled = true;
            loginButton.textContent = 'Entrando...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ token: token })
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // Se n칚o conseguir parsear JSON, verifica status
                    if (response.ok) {
                        // Login bem-sucedido mesmo sem JSON
                        window.location.replace('/');
                        return;
                    }
                    throw new Error('Resposta inv치lida do servidor');
                }
                
                if (response.ok && data.success) {
                    // Login bem-sucedido, redireciona (usando replace para evitar loop)
                    window.location.replace('/');
                } else {
                    showError(data.detail || 'Token inv치lido');
                    loginButton.disabled = false;
                    loginButton.textContent = 'Entrar';
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showError('Erro ao conectar com o servidor: ' + error.message);
                loginButton.disabled = false;
                loginButton.textContent = 'Entrar';
            }
        });
        
        // Verificar autentica칞칚o ao carregar (com delay para evitar loop)
        setTimeout(() => {
            checkAuth();
        }, 100);
    </script>
</body>
</html>

