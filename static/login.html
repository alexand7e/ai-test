<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SIA-Piau칤</title>
    <link rel="icon" type="image/svg+xml" href="/static/assets/favicon.svg">
    <link rel="stylesheet" href="/static/ui/base.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/login.css">
</head>

<body>
    <div class="login-container">
        <div class="login-box">
            <h2>游댏 Acesso Seguro</h2>
            <p>Digite o token de acesso para continuar</p>

            <div class="error-message" id="error-message"></div>

            <form id="login-form">
                <div class="login-form-group">
                    <label for="email-input">E-mail</label>
                    <input type="email" id="email-input" placeholder="seu@email.com" required autocomplete="email">
                </div>

                <div class="login-form-group">
                    <label for="password-input">Senha</label>
                    <input type="password" id="password-input" placeholder="Sua senha" required
                        autocomplete="current-password">
                </div>

                <button type="submit" class="login-button" id="login-button">
                    Entrar
                </button>
            </form>
        <p>N칚o tem uma conta? <a href="http://localhost:8000/singup">Crie uma conta.</a></p>
        </div>
    </div>

    <script src="/static/ui/utils.js"></script>
    <script>
        const API_BASE_URL = (window.SIAUtils && window.SIAUtils.getApiBaseUrl)
            ? window.SIAUtils.getApiBaseUrl()
            : (window.location && window.location.origin ? window.location.origin : 'http://localhost:8000');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');

        // Fun칞칚o para sanitizar input
        function sanitizeInput(value) {
            if (!value) return '';
            // Remove caracteres perigosos e limita tamanho
            return value.toString()
                .replace(/[<>]/g, '')
                .trim();
        }

        // Fun칞칚o para mostrar erro
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        // Verificar se j치 est치 autenticado
        let isCheckingAuth = false;
        let hasCheckedAuth = false;

        async function checkAuth() {
            // Evita m칰ltiplas verifica칞칫es simult칙neas ou repetidas
            if (isCheckingAuth || hasCheckedAuth) return;
            isCheckingAuth = true;
            hasCheckedAuth = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                    method: 'POST',
                    credentials: 'include'
                });

                // S칩 redireciona se a resposta for OK (200) e v치lida
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.valid === true) {
                        // J치 autenticado, redireciona apenas uma vez
                        window.location.replace('/');
                        return;
                    }
                }
            } catch (error) {
                // Ignora erro, continua na tela de login
                console.log('N칚o autenticado, permanecendo na tela de login');
            } finally {
                isCheckingAuth = false;
            }
        }

        // Handler de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = sanitizeInput(emailInput.value);
            const password = passwordInput.value; // Don't sanitize pwd too strictly or it breaks special chars, but server hashes it

            if (!email || !password) {
                showError('Por favor, preencha todos os campos');
                return;
            }

            loginButton.disabled = true;
            loginButton.textContent = 'Entrando...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email: email, senha: password })
                });

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // Se n칚o conseguir parsear JSON, verifica status
                    if (response.ok) {
                        // Login bem-sucedido mesmo sem JSON
                        window.location.replace('/');
                        return;
                    }
                    throw new Error('Resposta inv치lida do servidor');
                }

                if (response.ok) {
                    // Token recebido e setado no cookie
                    window.location.replace('/');
                } else {
                    showError(data.detail || 'Login falhou');
                    loginButton.disabled = false;
                    loginButton.textContent = 'Entrar';
                }
            } catch (error) {
                console.error('Erro no login:', error);
                showError('Erro ao conectar com o servidor: ' + error.message);
                loginButton.disabled = false;
                loginButton.textContent = 'Entrar';
            }
        });

        // Verificar autentica칞칚o ao carregar (com delay para evitar loop)
        setTimeout(() => {
            checkAuth();
        }, 100);
    </script>
</body>

</html>
